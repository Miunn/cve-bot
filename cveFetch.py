import requests
import json
import datetime

from model.cve import CVE


LAST_ENDPOINT = "https://cve.circl.lu/api/last"    

class CVEFetch:
    
    def get_last_cves() -> list[CVE]:
        r = requests.get(LAST_ENDPOINT)
        data = r.json()
        
        CVEs = []
        for cve in data:
            CVEs.append(CVEFetch.initCve(cve))
        
        return CVEs

    def get_cve(id_: str) -> CVE:
        r = requests.get(f"https://cve.circl.lu/api/cve/{id_}")
        data = r.json()
        
        if data is None:
            return None
        
        return CVEFetch.initCve(data)
    
    def initCve(cveJson) -> CVE:
        return CVE(
            datetime.datetime.fromisoformat(cveJson.get("Modified", "1970-01-07T01:00:00")),
            datetime.datetime.fromisoformat(cveJson.get("Published", "1970-01-07T01:00:00")),
            cveJson.get("access", {}),
            cveJson.get("assigner", ""),
            cveJson.get("capec", []),
            cveJson.get("cvss", ""),
            cveJson.get("cwe", ""),
            cveJson.get("id", ""),
            cveJson.get("impact", {}),
            datetime.datetime.fromisoformat(cveJson.get("last-modified", "1970-01-07T01:00:00")),
            cveJson.get("references", []),
            cveJson.get("summary", ""),
            cveJson.get("vulnerable_configuration", []),
            cveJson.get("vulnerable_configuration_cpe_2_2", []),
            cveJson.get("vulnerable_product", []),
        )